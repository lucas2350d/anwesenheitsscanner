<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QRâ€‘Anwesenheitsscanner</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#2196f3" />
  <link rel="icon" href="./logo.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    :root { --primary:#2196f3; --ok:#0a8; --warn:#d97706; --err:#b00; --bg:#f8f8f8; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    main { margin: 0 auto; max-width: 960px; padding: 16px; }
    header { display:flex; align-items:center; gap:12px; margin-bottom: 12px; }
    header img { width:48px; height:48px; }
    h1 { margin: 0; font-size: 1.25rem; }
    #status { color:#444; display:block; margin-top:4px; }
    .net { display:flex; gap:8px; align-items:center; margin: 8px 0 16px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:.85rem; }
    .on { background:#e7f5ff; color:#0369a1; }
    .off { background:#fff4e5; color:#9a3412; }
    .pending { background:#eefce9; color:#166534; }
    .controls { display:flex; gap:8px; align-items:center; margin-bottom: 12px; flex-wrap: wrap; }
    input[type="text"] { flex:1; min-width: 260px; padding: 10px 12px; border:1px solid #ccc; border-radius: 8px; font-size: 16px; background:white; }
    button { padding: 10px 14px; border: none; border-radius: 8px; background: var(--primary); color: white; font-size: 16px; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    table { width:100%; border-collapse: collapse; background:white; border-radius: 8px; overflow: hidden; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    thead th { background:#f2f6ff; }
    .ok { color: var(--ok); font-weight: 600; }
    .warn { color: var(--warn); font-weight: 600; }
    .err { color: var(--err); font-weight: 600; }
    .hint { font-size: .9rem; color:#555; margin-top: 4px; }
    .muted { color:#777; }
    small time { font-variant-numeric: tabular-nums; }

    /* Scanner Overlay */
    #scanModal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 9999; }
    #scanBox { background: #111; color: #fff; width: min(92vw, 720px); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
    #scanHeader { display:flex; align-items:center; justify-content: space-between; padding: 8px 12px; background:#0b0b0b; }
    #scanHeader h3 { margin:0; font-size:1rem; }
    #scanControls { display:flex; gap:8px; align-items:center; padding: 8px 12px; flex-wrap: wrap; }
    #scanVideo { width:100%; background:black; aspect-ratio: 4 / 3; object-fit: cover; }
    #scanClose { background:#444; }
    #torchBtn { background:#444; }
    #deviceSel { background:#222; color:#fff; border-radius: 8px; padding: 6px; border: 1px solid #333; }
    .scanHint { padding: 6px 12px; color:#cbd5e1; font-size:.9rem; }
    #frame { position:absolute; inset:0; pointer-events:none; }
    #frame::after { content:""; position:absolute; inset: 12% 10%; border: 3px solid rgba(255,255,255,.6); border-radius: 8px; }
  </style>
</head>
<body>
  <main>
    <header>
      <img src="./logo.png" alt="Vereinslogo" />
      <div>
        <h1>Anwesenheitsscanner Schwimmen</h1>
        <small id="status" aria-live="polite">Bereit</small>
      </div>
    </header>

    <div class="net" aria-live="polite">
      <span id="netBadge" class="badge on">Verbunden</span>
      <span id="qBadge" class="badge pending" hidden>Ausstehend: <b id="qCount">0</b></span>
      <small id="lastSyncWrap" class="muted" hidden>Letzte Synchronisierung: <time id="lastSync"></time></small>
    </div>

    <div class="controls">
      <input id="input" type="text" placeholder="ID scannen oder Name eingeben (z.â€¯B. Max Mustermann)" list="participants" autocomplete="off" autofocus />
      <datalist id="participants"></datalist>
      <button id="btn">Erfassen</button>
      <button id="btnScan" type="button" title="QR Ã¼ber Kamera scannen">Scannen</button>
      <button id="btnSync" type="button" title="Ausstehende EintrÃ¤ge jetzt hochladen">Jetzt synchronisieren</button>
    </div>
    <p class="hint">ðŸ’¡ Tipp: QRâ€‘Codes sollten die <b>ID</b> enthalten. Namen kannst du tippen: <span class="muted">Vorname Nachname</span>.</p>

    <section>
      <table>
        <thead><tr><th>ID / Name</th><th>Status</th><th>Zeit</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </section>
  </main>

  <!-- Scanner Modal -->
  <div id="scanModal" role="dialog" aria-modal="true" aria-label="QR-Scanner">
    <div id="scanBox">
      <div id="scanHeader">
        <h3>QRâ€‘Scanner</h3>
        <div style="display:flex; gap:8px;">
          <button id="torchBtn" type="button">ðŸ”¦</button>
          <button id="scanClose" type="button">SchlieÃŸen</button>
        </div>
      </div>
      <div id="scanControls">
        <label for="deviceSel">Kamera:</label>
        <select id="deviceSel"></select>
        <span class="scanHint">Halte den QRâ€‘Code im Rahmen ruhig.</span>
      </div>
      <div style="position:relative">
        <video id="scanVideo" playsinline muted></video>
        <div id="frame"></div>
        <canvas id="scanCanvas" style="display:none"></canvas>
      </div>
    </div>
  </div>

  <!-- Fallback-Lib lokal (fÃ¼r Offline-Scan) -->
  <script src="./lib/jsqr.min.js"></script>

  <script>
    // ðŸ”— Apps Script Execâ€‘URL hier eintragen:
    const API_ENDPOINT = "https://script.google.com/macros/s/DEPLOYMENT_ID/exec";

    // Service Worker relativ registrieren
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js")
        .then(() => {
          console.log("âœ… Service Worker registriert");
          if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: "INIT", payload: { api: API_ENDPOINT } });
            navigator.serviceWorker.controller.postMessage({ type: "GET_STATUS" });
          }
        })
        .catch(err => console.error("SW Fehler:", err));
    }

    const $status   = document.getElementById("status");
    const $input    = document.getElementById("input");
    const $btn      = document.getElementById("btn");
    const $btnSync  = document.getElementById("btnSync");
    const $btnScan  = document.getElementById("btnScan");
    const $rows     = document.getElementById("rows");
    const $dl       = document.getElementById("participants");
    const $netBadge = document.getElementById("netBadge");
    const $qBadge   = document.getElementById("qBadge");
    const $qCount   = document.getElementById("qCount");
    const $lastSync = document.getElementById("lastSync");
    const $lastWrap = document.getElementById("lastSyncWrap");

    function setNetBadge() {
      const online = navigator.onLine;
      $netBadge.textContent = online ? "Verbunden" : "Offline";
      $netBadge.className = "badge " + (online ? "on" : "off");
    }
    setNetBadge();
    window.addEventListener("online", () => {
      setNetBadge();
      setStatus("Verbunden â€“ synchronisiereâ€¦");
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: "FLUSH" });
        navigator.serviceWorker.controller.postMessage({ type: "GET_STATUS" });
      }
    });
    window.addEventListener("offline", setNetBadge);

    // Teilnehmerliste laden (Autocomplete)
    async function loadList() {
      try {
        setStatus("Lade Teilnehmerâ€¦");
        const url = new URL(API_ENDPOINT);
        url.searchParams.set("action", "list");
        const res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
        const data = await res.json();
        if (!data.ok) throw new Error(data.message || "Fehler bei der Liste");
        $dl.innerHTML = "";
        for (const p of data.items) {
          const opt = document.createElement("option");
          opt.value = `${p.full} (${p.id})`;
          $dl.appendChild(opt);
        }
        setStatus(`Teilnehmer geladen: ${data.count}`);
      } catch (e) {
        console.warn(e);
        setStatus("Teilnehmerliste konnte nicht geladen werden (offline?)");
      }
    }

    function setStatus(text) { $status.textContent = text; }
    function parseQuery(raw) {
      const m = raw.match(/\(([^)]+)\)\s*$/);
      if (m) return { id: m[1] };
      const parts = raw.trim().split(/\s+/);
      if (parts.length === 1) return { id: parts[0] };
      return { vorname: parts[0], nachname: parts.slice(1).join(" ") };
    }

    async function tryOnlineMark(query) {
      const url = new URL(API_ENDPOINT);
      Object.entries(query).forEach(([k, v]) => url.searchParams.set(k, v));
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 8000);
      try {
        const res = await fetch(url.toString(), { method: "GET", headers: { "Accept": "application/json" }, signal: controller.signal });
        clearTimeout(t);
        const data = await res.json().catch(() => ({}));
        return data;
      } catch (e) {
        clearTimeout(t);
        throw e;
      }
    }

    function addRow(label, cls, statusText, t) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${label}</td><td class="${cls}">${statusText}</td><td>${t}</td>`;
      $rows.prepend(tr);
    }

    async function enqueueForSync(query, label) {
      if (!navigator.serviceWorker.controller) {
        addRow(label, "err", "Keine SWâ€‘Steuerung", new Date().toLocaleTimeString());
        setStatus("Service Worker noch nicht aktiv â€“ bitte neu laden.");
        return;
      }
      navigator.serviceWorker.controller.postMessage({ type: "ENQUEUE", payload: { api: API_ENDPOINT, params: query } });
      setStatus("Offline gespeichert â€“ wird synchronisiert, sobald Verbindung da ist.");
      addRow(label, "warn", "Offline gespeichert", new Date().toLocaleTimeString());
      navigator.serviceWorker.controller.postMessage({ type: "GET_STATUS" });
    }

    async function handleSubmit() {
      const raw = $input.value.trim();
      if (!raw) return;
      const label = raw;
      const query = parseQuery(raw);
      $btn.disabled = true;
      setStatus("Erfasseâ€¦");
      const t = new Date().toLocaleTimeString();

      try {
        const res = await tryOnlineMark(query);
        if (res && res.ok) {
          const statusTxt = res.code === "already_marked" ? "Bereits erfasst" : "Erfasst";
          addRow(label, "ok", statusTxt, t);
          setStatus(statusTxt);
        } else {
          addRow(label, "err", res?.message || "Fehler", t);
          setStatus(res?.message || "Fehler");
        }
      } catch (_) {
        await enqueueForSync(query, label);
      }

      $btn.disabled = false;
      $input.value = "";
      $input.focus();
    }

    document.getElementById("btn").addEventListener("click", handleSubmit);
    $input.addEventListener("keydown", (e) => { if (e.key === "Enter") handleSubmit(); });
    document.getElementById("btnSync").addEventListener("click", () => {
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: "FLUSH" });
        navigator.serviceWorker.controller.postMessage({ type: "GET_STATUS" });
        setStatus("Synchronisiereâ€¦");
      }
    });

    // --- Scanner ---
    const $scanModal  = document.getElementById("scanModal");
    const $scanVideo  = document.getElementById("scanVideo");
    const $scanCanvas = document.getElementById("scanCanvas");
    const $scanClose  = document.getElementById("scanClose");
    const $torchBtn   = document.getElementById("torchBtn");
    const $deviceSel  = document.getElementById("deviceSel");
    document.getElementById("btnScan").addEventListener("click", openScanner);

    let scanRAF = null, stream = null, barcodeDetector = null, usingBarcodeDetector = false, torchOn = false;

    async function listCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === "videoinput");
      $deviceSel.innerHTML = "";
      for (const cam of cams) {
        const opt = document.createElement("option");
        opt.value = cam.deviceId; opt.textContent = cam.label || `Kamera ${$deviceSel.length+1}`;
        $deviceSel.appendChild(opt);
      }
      return cams;
    }

    async function startStream(deviceId) {
      stopStream();
      const constraints = {
        audio: false,
        video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: { ideal: "environment" } }
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      $scanVideo.srcObject = stream;
      await $scanVideo.play();
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};
      $torchBtn.style.display = caps.torch ? "inline-block" : "none";
      torchOn = false;
      return stream;
    }

    function stopStream() {
      if (scanRAF) cancelAnimationFrame(scanRAF);
      scanRAF = null;
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    async function toggleTorch() {
      const track = stream?.getVideoTracks?.()[0];
      if (!track) return;
      const caps = track.getCapabilities?.();
      if (!caps || !caps.torch) return;
      torchOn = !torchOn;
      await track.applyConstraints({ advanced: [{ torch: torchOn }] });
      $torchBtn.textContent = torchOn ? "ðŸ”¦ Aus" : "ðŸ”¦ An";
    }

    function closeScanner() {
      stopStream();
      $scanModal.style.display = "none";
    }

    async function openScanner() {
      try {
        $scanModal.style.display = "flex";
        try { await listCameras(); } catch {}
        await startStream($deviceSel.value || undefined);

        usingBarcodeDetector = ("BarcodeDetector" in window);
        if (usingBarcodeDetector) {
          try { barcodeDetector = new BarcodeDetector({ formats: ["qr_code"] }); } catch { usingBarcodeDetector = false; }
        }
        scanLoop();
      } catch (e) {
        setStatus("Kamera konnte nicht gestartet werden. PrÃ¼fe Berechtigungen & HTTPS.");
        console.error(e);
        closeScanner();
      }
    }

    function processScan(text) {
      if (!text) return;
      $input.value = text.trim();
      closeScanner();
      handleSubmit();
    }

    async function scanLoop() {
      if (!$scanVideo.srcObject) return;
      try {
        if (usingBarcodeDetector && barcodeDetector) {
          const codes = await barcodeDetector.detect($scanVideo);
          if (codes && codes.length > 0) {
            const text = codes[0].rawValue || codes[0].rawValue;
            return processScan(text);
          }
        } else if (window.jsQR) {
          const w = $scanVideo.videoWidth || 640;
          const h = $scanVideo.videoHeight || 480;
          $scanCanvas.width = w; $scanCanvas.height = h;
          const ctx = $scanCanvas.getContext("2d");
          ctx.drawImage($scanVideo, 0, 0, w, h);
          const img = ctx.getImageData(0, 0, w, h);
          const code = jsQR(img.data, w, h, { inversionAttempts: "dontInvert" });
          if (code && code.data) return processScan(code.data);
        }
      } catch (e) { /* schlucken & weiterscannen */ }
      scanRAF = requestAnimationFrame(scanLoop);
    }

    document.getElementById("scanClose").addEventListener("click", closeScanner);
    document.getElementById("torchBtn").addEventListener("click", toggleTorch);
    $deviceSel.addEventListener("change", async () => { await startStream($deviceSel.value); });

    // SWâ€‘Events
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.addEventListener("message", (event) => {
        const msg = event.data || {};
        if (msg.type === "QUEUE_STATUS") {
          const pending = msg.pending || 0;
          if (pending > 0) { $qBadge.hidden = false; $qCount.textContent = String(pending); }
          else { $qBadge.hidden = true; }
          if (msg.lastSync) { $lastWrap.hidden = false; $lastSync.textContent = new Date(msg.lastSync).toLocaleString(); }
          if (msg.info) setStatus(msg.info);
        } else if (msg.type === "SYNC_DONE") {
          setStatus("Synchronisierung abgeschlossen");
        } else if (msg.type === "SYNC_PROGRESS") {
          setStatus(`Synchronisiereâ€¦ (${msg.done}/${msg.total})`);
        }
      });
    }

    // Initial
    loadList();
  </script>
</body>
</html>
